---
title: 西南交大教务模拟登陆
date: 2019-01-29 18:27:08
tags: 爬虫
categories: 学校
---

最近由于需要做一个获取学生课表的项目，就去研究了下如何模拟登录，并用Python成功模拟登录。在此记录一下自己的分析过程。

<!--more-->	

## 登录分析

使用Chrome登录[教务网](http://dean.vatuu.com/service/login.html)，打开调试模式，使用NetWork记录点击“登录按钮”后发生的过程

* 点击登录后浏览器请求的地址为`http://dean.vatuu.com/vatuu/UserLoginAction`，这就是我们需要记录的一个url，模拟登录时就向改网址发送请求；
* 我们需要重点分析Header和cookie。查看`Response Header`，该网址返回的Header信息有个`Set-Cookie`字段；在`Request-Headers`中，有一个`JSESSIONID`
* `UserLoadingAction`是登录成功后跳转的一个页面。查看`Request Header`中的`Cookie`为学号+JSESSIONID，因此明白JSESSIONID以及如何获取它至关重要。
* 另一个问题就是验证码，我采用人工输入的方式。审查元素，查看验证码的接口，得到其地址。
* 复制这个地址，粘贴到地址栏，得到验证码。
* 我猜想验证码和`JSESSIONID`有很大关系。退出教务登录，打开调试工具的“Application-Cookies”可以看到保存的Cookie，清除
* 刷新验证码地址，可以看到会再次出现`JSESSIONID`
* 因此可以假设通过验证码获取`JSESSIONDI`

## 使用Python尝试登录

```python
def get_jsessionid():
    """
    访问登录界面，通过Response Header用于获取set-cookie
    """
    s = requests.Session()
    r = s.get(get_photo_url)
    with open('./static/ranstring.jpg', 'wb') as file:
        file.write(r.content)
    get_head = r.headers
    set_cookie = str(get_head['Set-Cookie'])
    jessid = set_cookie.split(';')[0]
    return jessid
```

运行后，可以看到获取到了`JSESSIONID`。

之后模拟登录。

```python
jsessionid = get_jsessionid()
full_cookie = 'username='+str(data['username'])+'; ' + str(jsessionid)
log_msg = ""


def login():
    """
    登录
    """
    # 登录需要的cookie只有jsessionid
    headers['cookie'] = jsessionid
    data['ranstring'] = input("验证码：")
    # UserLoginAction
    res = requests.post(
        user_log_url, data, headers=headers, allow_redirects=True)
    log_msg = res.text
    log_msg = json.loads(log_msg)
    print(log_msg['loginMsg'])
```

看到出现教务返回的登录成功等字样就表示登录成功。

尝试获取课表时，却提示未登录。我认为`UserLoadingAction`这一步也是必须的。

## 再次分析

* 查看`UserLoadingAction`，发现向它传送的数据中有一个“loginMsg”字段，这正是点击‘’登录系统“成功后返回的字段的一部分
* 在登录时访问`UserLoadingAction`查看是否生效

```python
def login():
    """
    登录
    两步：UserLoginAction + UserLoadingAction
    """
    headers['cookie'] = jsessionid
    data['ranstring'] = input("验证码：")
    # UserLoginAction
    res = requests.post(
        user_log_url, data, headers=headers, allow_redirects=True)
    # with open('./response.html') as file:
    # file.writer(response.text)
    log_msg = res.text
    log_msg = json.loads(log_msg)
    print(log_msg['loginMsg'])
    # UserLoadingAction
    headers['cookie'] = full_cookie
    data_loading = {
        'loginMsg': log_msg['loginMsg']
    }
    res = requests.post(user_loading_url, data=data_loading, headers=headers)
```

查看res，会提示登录成功，这时在访问课表的网址，就正常返回了课表

## 总结

* 正确的Header和Cookie很重要